!function t(e,n,a){function r(o,s){if(!n[o]){if(!e[o]){var c="function"==typeof require&&require;if(!s&&c)return c(o,!0);if(i)return i(o,!0);var u=new Error("Cannot find module '"+o+"'");throw u.code="MODULE_NOT_FOUND",u}var h=n[o]={exports:{}};e[o][0].call(h.exports,function(t){var n=e[o][1][t];return r(n||t)},h,h.exports,t,e,n,a)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<a.length;o++)r(a[o]);return r}({1:[function(t,e,n){"use strict";function a(){this.listeners={}}Object.defineProperty(n,"__esModule",{value:!0}),a.prototype.trigger=function(t,e){var n=arguments;(this.listeners[t]||[]).forEach(function(t){"function"==typeof t&&t.apply(null,[].slice.call(n,1))})},a.prototype.on=function(t,e){this.listeners[t]=this.listeners[t]||[],this.listeners[t].push(e)},a.prototype.off=function(t,e){this.listeners[t]=e?(this.listeners[t]||[]).filter(function(t){return t!==e}):(this.listeners[t]||[]).lenght=0},a.prototype.once=function(t,e){var n=this;this.on(t,function a(){e.apply(null,arguments),n.off(t,a)})},n.default=a},{}],2:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var a=t("./services"),r=function(t,e){var n=this;this.htmlEl=t,this.eventBus=e,this.favoritesList,this.render(),this.htmlEl.onclick=function(t){if("btnDelete"==t.target.className){var e=t.target.previousSibling.text;"string"==typeof n.favoritesList&&(n.favoritesList=n.favoritesList.split(","));var r=n.favoritesList.filter(function(t){return t!=e});n.favoritesList=r.join(","),a.iStorage.setData("favoritesList",n.favoritesList).then(function(){n.render()})}},this.eventBus.on("weatherMap:changeFavorites",function(t){a.iStorage.getData("favoritesList").then(function(e){return n.favoritesList=e?e.split(","):[],n.favoritesList.unshift(t),n.favoritesList.join(",")}).then(function(t){a.iStorage.setData("favoritesList",t)}).then(function(){n.render()}).catch(function(){console.log("ошибка добавления избранного")})})};r.prototype.render=function(){var t=this;a.iStorage.getData("favoritesList").then(function(e){t.favoritesList=e?e.split(","):[];for(var n="<ul>",a=0;a<t.favoritesList.length;a++)n+='<li value="'+t.favoritesList[a]+'"><a href="#city='+t.favoritesList[a]+'">'+t.favoritesList[a]+'</a><button class="btnDelete">X</button ></li>';n+="</ul>",t.htmlEl.innerHTML=n}).catch(function(){console.log("ошибка удаления")})},n.default=r},{"./services":8}],3:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var a=t("./services"),r=function(t,e){var n=this;this.htmlEl=t,this.eventBus=e,this.historyList,this.render(),this.eventBus.on("weatherMap:changeHistory",function(t){a.iStorage.getData("historyList").then(function(e){return n.historyList=e?e.split(","):[],n.historyList.unshift(t),n.historyList.length>5&&n.historyList.pop(),n.historyList.join(",")}).then(function(t){a.iStorage.setData("historyList",t)}).then(function(){n.render()}).catch(function(){console.log("ошибка добавления истории")})})};r.prototype.render=function(){var t=this;a.iStorage.getData("historyList").then(function(e){t.historyList=e?e.split(","):[];for(var n="<ul>",a=0;a<t.historyList.length;a++)n+='<li><a href="#city='+t.historyList[a]+'">'+t.historyList[a]+"</a></li>";n+="</ul>",t.htmlEl.innerHTML=n})},n.default=r},{"./services":8}],4:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var a=function(t){var e=this;this.routes=t.routes||[],this.prevRoute,this.prevParam,this.activeRoute,this.activeParam,window.addEventListener("hashchange",function(){return e.handleHashChange(window.location.hash)}),this.handleHashChange(window.location.hash)};a.prototype.handleHashChange=function(t){var e=this;t=t.slice(1),this.routes.forEach(function(n,a,r){"string"==typeof n.match&&n.match===t?e.activeRoute=n:"function"==typeof n.match&&n.match(t)?e.activeRoute=n:n.match instanceof RegExp&&n.match.test(t)&&(e.activeRoute=n)}),this.activeParam=this.getParams(t),this.execFunctions()},a.prototype.getParams=function(t){var e=t.match(this.activeRoute.match)||[];return 2==e.length?e[1]:e},a.prototype.execFunctions=function(){var t=this;Promise.resolve().then(function(){t.prevRoute&&t.prevRoute.onLeave&&t.prevRoute.onLeave(t.prevParam)}).then(function(){t.activeRoute&&t.activeRoute.onBeforeEnter&&t.activeRoute.onBeforeEnter(t.activeParam)}).then(function(){t.activeRoute&&t.activeRoute.onEnter&&t.activeRoute.onEnter(t.activeParam)}).then(function(){t.prevRoute=t.activeRoute,t.prevParam=t.activeParam}).catch(function(){return alert("маршрут отсутствует")})},n.default=a},{}],5:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var a=function(t,e){var n=this;this.htmlEl=t,this.eventBus=e,this.eventBus.on("weatherMap:changeForecast",function(t){return n.render(t)})};a.prototype.render=function(t){this.htmlEl.innerHTML=t},n.default=a},{}],6:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var a=t("./services"),r=function(t,e,n){var a=this;this.map,this.center=t,this.eventBus=e,this.ymaps=n,this.ymaps.ready(function(){return a.drawMap()})};r.prototype.drawMap=function(){this.map=new this.ymaps.Map("myMap",{center:this.center,controls:["zoomControl"],zoom:10});var t=new this.ymaps.control.Button({data:{src:"https://rawgit.com/NatallyaSeverina/js--base-course/06ht/06/ht/SeverinaNatallya/build/img/favorites.png"},options:{float:"right"}});this.map.controls.add(t),this.addHandlers(t)},r.prototype.addHandlers=function(t){var e=this;t.events.add("click",function(t){e.center=e.map.getCenter(),e.eventBus.trigger("weatherMap:add2Favorite",e.center)}),this.map.events.add("boundschange",(0,a.debounce)(function(t){e.eventBus.trigger("weatherMap:centerChange",t.get("newCenter")),(0,a.changeHashByMapState)(t.get("newCenter"))},2e3)),this.eventBus.on("weatherMap:setMapCenter",function(t){e.center=t,e.render()})},r.prototype.render=function(){this.map.panTo(this.center,{duration:2e3})},n.default=r},{"./services":8}],7:[function(t,e,n){"use strict";function a(t){return t&&t.__esModule?t:{default:t}}var r=t("./services"),i=a(t("./EventBus")),o=a(t("./Router")),s=a(t("./WeatherForecast")),c=a(t("./RequestHistory")),u=a(t("./FavoriteList")),h=a(t("./YandexMap")),f=new i.default,l=document.forms.main;l.addEventListener("submit",function(t){t.preventDefault(),(0,r.changeMapStateByCityName)(l,f,l.search.value)}),new s.default(document.getElementsByClassName("weather")[0],f),new c.default(document.getElementsByClassName("history")[0],f),new u.default(document.getElementsByClassName("favorites")[0],f),(0,r.getMapCenterFromHash)(l.rb.value).then(function(t){new h.default(t,f,ymaps),f.trigger("weatherMap:centerChange",t)}).catch(function(t){f.trigger("weatherMap:changeForecast","ошибка получения прогноза")}),f.on("weatherMap:centerChange",function(t){var e=t[0],n=t[1],a=void 0;"fetch"==l.rb.value?(0,r.getForecastByCoordFetch)({lat:e,lng:n}).then(function(t){var e=t.temp,n=t.descript,r=t.humidity,i=t.windSpeed;a="<h2>В ближайшие 3 часа ожидается:<br/>температура "+e+" C<br/>влажность "+r+"%<br/>скорость ветра "+i+" м/с<br/>"+n+"</h2>",f.trigger("weatherMap:changeForecast",a)}).catch(function(t){f.trigger("weatherMap:changeForecast","ошибка получения прогноза")}):(0,r.getForecastByCoordXHR)({lat:e,lng:n}).then(function(t){var e=t.temp,n=t.descript,r=t.humidity,i=t.windSpeed;a="<h2>В ближайшие 3 часа ожидается:<br/>температура "+e+" C<br/>влажность "+r+"%<br/>скорость ветра "+i+" м/с<br/>"+n+"</h2>",f.trigger("weatherMap:changeForecast",a)}).catch(function(t){f.trigger("weatherMap:changeForecast","ошибка получения прогноза")})}),f.on("weatherMap:add2Favorite",function(t){var e=t[0],n=t[1];"fetch"==l.rb.value?(0,r.getCityNameByCoordFetch)({lat:e,lng:n}).then(function(t){f.trigger("weatherMap:changeFavorites",t)}):(0,r.getCityNameByCoordXHR)({lat:e,lng:n}).then(function(t){f.trigger("weatherMap:changeFavorites",t)})});new o.default({routes:[{name:"index",match:"",onEnter:function(){}},{name:"about",match:"about",onEnter:function(){document.getElementById("about").hidden=!1},onLeave:function(){document.getElementById("about").hidden=!0}},{name:"main",match:/city=(.+)/i,onEnter:function(t){(0,r.changeMapStateByCityName)(l,f,t)}},{name:"map",match:/center=(-?\d*[.]?\d+,-?\d*[.]?\d+)/,onEnter:function(t){}},{name:"author",match:"author",onEnter:function(){document.getElementById("author").hidden=!1},onLeave:function(){document.getElementById("author").hidden=!0}}]})},{"./EventBus":1,"./FavoriteList":2,"./RequestHistory":3,"./Router":4,"./WeatherForecast":5,"./YandexMap":6,"./services":8}],8:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var a={setData:function(t,e){return new Promise(function(n,a){window.localStorage.setItem(t,e),n([t,e])})},getData:function(t){return Promise.resolve(window.localStorage.getItem(t))}},r=function(){return fetch("https://api.userinfo.io/userinfos").then(function(t){return t.json()}).then(function(t){return{lat:t.position.latitude,lng:t.position.longitude}}).catch(function(){alert("Ошибка запроса")})},i=function(t){return fetch("https://api.openweathermap.org/data/2.5/forecast?q="+t+"&units=metric&lang=ru&APPID=97248aca315ea6cccb5cf1cab8b0771b").then(function(t){return t.json()}).then(function(t){return{temp:t.list[0].main.temp_max,descript:t.list[0].weather[0].description,humidity:t.list[0].main.humidity,windSpeed:t.list[0].wind.speed,lat:t.city.coord.lat,lng:t.city.coord.lon}}).catch(function(){alert("Ошибка запроса, проверьте название нас.пункта")})},o=function(){return new Promise(function(t,e){var n=new XMLHttpRequest;n.open("GET","https://api.userinfo.io/userinfos",!0),n.send(),n.onreadystatechange=function(){if(4==n.readyState)if(200!=n.status)alert("ошибка: "+(n.status?n.statusText:"запрос не удался")),e();else{var a=JSON.parse(n.response);t({lat:a.position.latitude,lng:a.position.longitude})}}})},s=function(t){return new Promise(function(e,n){var a=new XMLHttpRequest;a.open("GET","https://api.openweathermap.org/data/2.5/forecast?q="+t+"&units=metric&lang=ru&APPID=97248aca315ea6cccb5cf1cab8b0771b",!0),a.send(),a.onreadystatechange=function(){if(4==a.readyState)if(200!=a.status)alert("ошибка: "+(a.status?a.statusText:"запрос не удался, проверьте название нас.пункта")),n();else{var t=JSON.parse(a.response);e({temp:t.list[0].main.temp_max,descript:t.list[0].weather[0].description,humidity:t.list[0].main.humidity,windSpeed:t.list[0].wind.speed,lat:t.city.coord.lat,lng:t.city.coord.lon})}}})};n.debounce=function(t,e){function n(){if(i)return a=arguments,void(r=this);t.apply(this,arguments),i=1,setTimeout(function(){i=0,r&&(n.apply(r,a),a=r=null)},e)}var a,r,i=0;return n},n.changeHashByMapState=function(t){window.location.hash="center="+t},n.getMapCenterFromHash=function(t){return new Promise(function(e,n){var a=window.location.hash.match(/#center=(-?\d*[.]?\d+),(-?\d*[.]?\d+)/),i=void 0;a?(i=[+a[1],+a[2]],e(i)):"XHR"==t?o().then(function(t){var n=t.lat,a=t.lng;e(i=[+n,+a])}):r().then(function(t){var n=t.lat,a=t.lng;e(i=[+n,+a])})})},n.getUserInfoFetch=r,n.getCityNameByCoordFetch=function(t){var e=t.lat,n=t.lng;return fetch("https://api.openweathermap.org/data/2.5/forecast?lat="+e+"&lon="+n+"&units=metric&lang=ru&APPID=97248aca315ea6cccb5cf1cab8b0771b").then(function(t){return t.json()}).then(function(t){return t.city.name}).catch(function(){alert("Ошибка запроса")})},n.getForecastByCoordFetch=function(t){var e=t.lat,n=t.lng;return fetch("https://api.openweathermap.org/data/2.5/forecast?lat="+e+"&lon="+n+"&units=metric&lang=ru&APPID=97248aca315ea6cccb5cf1cab8b0771b").then(function(t){return t.json()}).then(function(t){return{temp:t.list[0].main.temp_max,descript:t.list[0].weather[0].description,humidity:t.list[0].main.humidity,windSpeed:t.list[0].wind.speed}}).catch(function(){alert("Ошибка запроса")})},n.getForecastByCityNameFetch=i,n.getUserInfoXHR=o,n.getCityNameByCoordXHR=function(t){var e=t.lat,n=t.lng;return new Promise(function(t,a){var r=new XMLHttpRequest;r.open("GET","https://api.openweathermap.org/data/2.5/forecast?lat="+e+"&lon="+n+"&units=metric&lang=ru&APPID=97248aca315ea6cccb5cf1cab8b0771b",!0),r.send(),r.onreadystatechange=function(){if(4==r.readyState)if(200!=r.status)alert("ошибка: "+(r.status?r.statusText:"запрос не удался")),a();else{var e=JSON.parse(r.response);t(e.city.name)}}})},n.getForecastByCoordXHR=function(t){var e=t.lat,n=t.lng;return new Promise(function(t,a){var r=new XMLHttpRequest;r.open("GET","https://api.openweathermap.org/data/2.5/forecast?lat="+e+"&lon="+n+"&units=metric&lang=ru&APPID=97248aca315ea6cccb5cf1cab8b0771b",!0),r.send(),r.onreadystatechange=function(){if(4==r.readyState)if(200!=r.status)alert("ошибка: "+(r.status?r.statusText:"запрос не удался")),a();else{var e=JSON.parse(r.response);t({temp:e.list[0].main.temp_max,descript:e.list[0].weather[0].description,humidity:e.list[0].main.humidity,windSpeed:e.list[0].wind.speed})}}})},n.getForecastByCityNameXHR=s,n.changeMapStateByCityName=function(t,e,n){var a=void 0;"fetch"==t.rb.value?i(n).then(function(t){var r=t.temp,i=t.descript,o=t.humidity,s=t.windSpeed,c=t.lat,u=t.lng;a="<h2>В ближайшие 3 часа ожидается:<br/>температура "+r+" C<br/>влажность "+o+"%<br/>скорость ветра "+s+" м/с<br/>"+i+"</h2>",e.trigger("weatherMap:changeForecast",a),e.trigger("weatherMap:setMapCenter",[+c,+u]),e.trigger("weatherMap:changeHistory",n)}).catch(function(t){e.trigger("weatherMap:changeForecast","ошибка получения прогноза")}):s(n).then(function(t){var r=t.temp,i=t.descript,o=t.humidity,s=t.windSpeed,c=t.lat,u=t.lng;a="<h2>В ближайшие 3 часа ожидается:<br/>температура "+r+" C<br/>влажность "+o+"%<br/>скорость ветра "+s+" м/с<br/>"+i+"</h2>",e.trigger("weatherMap:changeForecast",a),e.trigger("weatherMap:setMapCenter",[+c,+u]),e.trigger("weatherMap:changeHistory",n)}).catch(function(t){e.trigger("weatherMap:changeForecast","ошибка получения прогноза")})},n.iStorage=a},{}]},{},[7]);